#! /Library/Frameworks/Python.framework/Versions/3.12/bin/python3
import os
from functools import cache

TEST_FILE = f'{os.path.dirname(__file__)}/test_input'
INPUT_FILE = f'{os.path.dirname(__file__)}/input'


def parse_file_part_1(file):  
  def parse_line(line):
    springs, report = line.split(' ')
    return springs, tuple(int(nb) for nb in report.split(','))
  with open(file) as input:
    return [parse_line(line.strip()) for line in input.readlines()]
  
def parse_file_part_2(file):
  def parse_line(line):
    springs, report = line.split(' ')
    return '?'.join([springs for _ in range(5)]), tuple([int(nb) for nb in report.split(',')]*5)
  with open(file) as input:
    return [parse_line(line.strip()) for line in input.readlines()]

def space_for_rest(report, ri, curr):
   todo = len(report) - ri - 1
   curr = max(0, curr)
   return sum(report[ri+1:]) + curr + todo - 1

@cache
def eat(string, report):
  if sum(report) > len(string):
    return 0
  if len(string) == 0:
    return 1 if len(report) == 0 else 0

  char = string[0]
  if char == '.':
    return eat(string[1:], report)

  if char == '#':
    if len(report) == 0: return 0
    patch_len = report[0]
    if string[:patch_len].count('.') > 0 or (patch_len < len(string) and string[patch_len] == '#'):
      return 0
    return eat(string[patch_len + 1:], report[1:])

  return eat('.'+string[1:], report) + eat('#'+string[1:], report)

def part_1(file):
  rows = parse_file_part_1(file)
  return sum(eat(*row) for row in rows)

def part_2(file):
  rows = parse_file_part_2(file)
  return sum(eat(*row) for row in rows)

# Solution
print(part_1(INPUT_FILE)) # 7670
print(part_2(INPUT_FILE)) # 157383940585037

# Tests
assert(part_1(TEST_FILE)) == 21
assert(part_2(TEST_FILE)) == 525152

assert eat('.?#?####?????###?', (1, 4, 6)) == 2
assert eat('???????#???.?##', (1, 1, 1, 1, 3)) == 24
assert eat('??.???????????.?', (4, 2)) == 15
assert eat('??#.?????#???', (1, 1, 1, 5)) == 7
assert eat('.#?#???.#???#?#??', (1, 1, 1, 7)) == 3
assert eat('?.#??.??#????????', (1, 1, 1, 10)) == 2
assert eat('?##???#?#?', (2, 5)) == 2
assert eat('?.????????????', (5, 1, 2)) == 10
assert eat('???????.#?#???', (1, 1, 1, 6)) == 10
assert eat('???#????????#?#???', (2, 1, 8)) == 20
assert eat('.#?.???????', (2, 1, 2)) == 10
assert eat('?#.#?#.#??????', (1, 3, 1, 4)) == 2
assert eat('??????????..#??????', (2, 2, 1, 1, 1, 3)) == 35
assert eat('???#?#?#??.?#??', (8, 4)) == 3
assert eat('###????????', (3, 3, 2)) == 3
assert eat('??.??##?#??..#.??', (1, 4, 2, 1, 2)) == 2
assert eat('??????.???#???###', (3, 8)) == 4
assert eat('.#..?????????###?#', (1, 1, 10)) == 3
assert eat('??#?.??.?##?#', (1, 1, 5)) == 3
assert eat('?##????.?.#?#??', (3, 2, 1, 1, 2)) == 3
assert eat('?????#???#?????.??', (1, 1, 1, 1, 2, 2)) == 35
assert eat('???#?#????#', (4, 3)) == 2
assert eat('???????????', (1, 1, 3)) == 35
assert eat('??##??????.????', (3, 2, 1, 2)) == 19
assert eat('.?#.?????????', (2, 5)) == 5
assert eat('??#?#?#???', (5, 3)) == 1
assert eat('?#??????#??#?', (2, 1, 6)) == 8
assert eat('???#?#??#?##', (1, 2, 1, 4)) == 1
assert eat('?...#?#?????#??#???', (1, 3, 1, 6)) == 7
assert eat('???????.??????????', (1, 3, 1, 1, 1, 2)) == 125
assert eat('?.??????.??.#?#???#', (1, 2, 1, 1, 5)) == 29
assert eat('???????.????#??', (1, 2, 2, 2)) == 32
assert eat('#????.????????', (1, 1, 2, 2)) == 34
assert eat('????##??..???#.#???#', (1, 2, 1, 3, 5)) == 3
assert eat('?????.??????????', (4, 2, 2, 3)) == 8
assert eat('..?..??#???', (1, 4)) == 4
assert eat('?##?#?.?????#', (6, 1, 2)) == 3
assert eat('.????#?.??????', (1, 1, 1, 2)) == 24
assert eat('??..#?????#??#?', (2, 1, 1, 7)) == 1
assert eat('?.#???##??????#?', (7, 5)) == 2
assert eat('?????????????', (1, 10)) == 3
assert eat('????#???#.?????#????', (6, 7)) == 4
assert eat('?#???.?#???', (2, 1, 5)) == 3
assert eat('.?..#.???#??...???', (1, 1, 1, 1, 1, 3)) == 2
assert eat('????#?#?????##??#?', (4, 1, 3, 6)) == 1
assert eat('??????#?.??', (1, 2)) == 10
assert eat('?#.????.???.?????#', (1, 3, 1, 2, 3)) == 6
assert eat('#.????????', (1, 5)) == 4
assert eat('?##?????.??', (2, 2)) == 4
assert eat('???#.#???????', (1, 1, 4, 2)) == 4
assert eat('?????#??.???', (1, 1, 2, 2)) == 8
assert eat('?#??????????#??????', (2, 6, 1, 2)) == 29
assert eat('.?#?????????', (6, 2)) == 5
assert eat('??###?????#.?.??.??#', (1, 6, 1, 1, 2, 3)) == 1
assert eat('?#????.?????', (3, 1, 1, 2)) == 9
assert eat('???.??#.???????', (2, 1, 6)) == 4
assert eat('????.???##???.???', (2, 4, 3)) == 10
assert eat('?.?##.??????', (3, 4)) == 3
assert eat('??????#??????', (4, 3)) == 9
assert eat('.??#??###.#???##', (3, 3, 1, 3)) == 2
assert eat('..??.#???#', (1, 5)) == 2
assert eat('#??.?#????.??#??', (1, 1, 3, 1, 2)) == 9
assert eat('??...#???#???###?#?', (1, 13)) == 2
assert eat('?????#?#???', (1, 3, 4)) == 2
assert eat('??#???..???', (6, 3)) == 1
assert eat('?#.??#?????.?#??', (1, 4, 4)) == 3
assert eat('???.??.??.#???##', (1, 1, 1, 1, 6)) == 4
assert eat('????#??#?#??#????#??', (1, 1, 1, 2, 2, 3)) == 10
assert eat('?.?##.?.?#', (3, 2)) == 1
assert eat('#.??#??????', (1, 3, 2)) == 9
assert eat('?.?#??.??.????', (3, 1, 2)) == 14
assert eat('#?..????????#?', (2, 8)) == 2
assert eat('??????????#??', (2, 7)) == 9
assert eat('??#.?.?.??????##??', (2, 1, 4, 3)) == 6
assert eat('??##?????#?', (3, 3)) == 4
assert eat('???????#?.?#???', (2, 1, 2, 3)) == 18
assert eat('#??#??#???#?#?', (1, 3, 1, 5)) == 2
assert eat('??.????????', (1, 8)) == 2
assert eat('?????.??#?????????', (1, 2, 11)) == 6
assert eat('#?.?#.#??????', (1, 1, 1, 3)) == 3
assert eat('??.?##??????', (1, 3, 2)) == 14
assert eat('??????.??#?.??.?????', (4, 4, 1, 2)) == 33
assert eat('???..????#??#???#', (3, 7, 3)) == 1
assert eat('#.?.????#???#?????#?', (1, 1, 2, 3, 8)) == 4
assert eat('???.??????.?#??', (1, 1, 1, 1, 4)) == 22
assert eat('???#?.??????#??', (5, 8)) == 2
assert eat('.??????????', (2, 7)) == 1
assert eat('??.?????.#??#?????', (1, 1, 1, 1, 6)) == 28
assert eat('?????#?????????#?##', (1, 2, 1, 2, 1, 6)) == 3
assert eat('.???????#??#?#.#??', (3, 2, 1, 1, 3)) == 7
assert eat('?????.#..????#?', (1, 1, 1, 1, 4)) == 8
assert eat('?.??##?.?.???????', (3, 4)) == 8
assert eat('.????#.??#???#???', (2, 2, 9)) == 2
assert eat('??#??????#?#??', (4, 1, 4)) == 9
assert eat('?.????.?#???', (1, 3)) == 10
assert eat('###?#.??????????', (5, 1, 2, 2)) == 20
assert eat('.????..???#??#??????', (4, 11)) == 3
assert eat('?##?#????#???#?????', (5, 7, 2)) == 12
assert eat('.#??.??#????', (1, 1, 3, 2)) == 3
assert eat('.????#?.??##?', (3, 2, 5)) == 1
assert eat('?#?.?????..??????#?#', (2, 1, 3, 1, 1, 3)) == 12
assert eat('????.##????#?????', (3, 3, 8)) == 2
assert eat('??#?????#????#????', (3, 2, 1, 5, 2)) == 3
assert eat('??#?##?.??.??.?.???', (6, 1, 1, 2)) == 32
assert eat('??##????????.???#?', (10, 3)) == 6
assert eat('#???????????##?', (2, 6, 4)) == 3
assert eat('?????#????##???', (2, 7)) == 6
assert eat('????###?.???..?????', (7, 1, 5)) == 6
assert eat('????#???.?#', (2, 2)) == 2
assert eat('????#.?..?????#?', (5, 5)) == 2
assert eat('??????#????#?', (1, 9)) == 5
assert eat('.??#??#.?.?#', (3, 1, 2)) == 2
assert eat('?#???.#??.#.?????##?', (1, 1, 1, 1, 1, 8)) == 2
assert eat('?#####?#?#????', (5, 1, 1, 3)) == 1
assert eat('.??##????#', (2, 3)) == 1
assert eat('??#??#??????', (3, 1, 5)) == 2
assert eat('?#?.??#???#?', (2, 7)) == 4
assert eat('.????.??##.???', (3, 2, 2)) == 4
assert eat('?.???????#?????#??', (5, 8)) == 3
assert eat('?.??#?#.?.??.?????', (4, 2)) == 5
assert eat('#????.#.###?????????', (2, 1, 3, 6)) == 3
assert eat('??????##??#???#???', (1, 4, 1, 1, 2)) == 14
assert eat('?#??..?#???#??##?', (1, 1, 2, 5)) == 2
assert eat('?##?..?#?#..???', (2, 4, 3)) == 1
assert eat('?.??.??.?..?????', (2, 3)) == 6
assert eat('???.??????.??#???', (3, 2, 6)) == 6
assert eat('?????..#???#???????', (2, 1, 4, 2)) == 36
assert eat('#..#??#?#???', (1, 1, 4, 2)) == 1
assert eat('.?.?#?##??????', (1, 1, 3, 2)) == 3
assert eat('??#????.??????', (4, 4)) == 9
assert eat('????????#??????#??', (8, 5)) == 9
assert eat('.#??#?.?#??#', (1, 3, 5)) == 1
assert eat('?????#?##?#?', (2, 6)) == 3
assert eat('##??????????????.???', (7, 3, 3, 2)) == 6
assert eat('#?#??#?..???###???', (1, 1, 2, 9)) == 2
assert eat('??????????#', (4, 4)) == 3
assert eat('????#??.??.??.??', (5, 2)) == 9
assert eat('?#?????#??#.?.??', (2, 1, 1, 1, 2)) == 8
assert eat('.?#?#???.???????????', (6, 9)) == 6
assert eat('??#???.??????', (4, 2)) == 15
assert eat('.????????????', (1, 4, 3)) == 10
assert eat('?.??.?????????#?', (1, 5, 3)) == 16
assert eat('???.#.#?##???.??', (1, 1, 5, 1, 2)) == 3
assert eat('????????#?#????????', (1, 1, 9, 2)) == 35
assert eat('?#??#???????#', (2, 2, 2, 2)) == 7
assert eat('.???###??#??#??', (5, 2, 4)) == 1
assert eat('.#?.????#.??.???', (2, 1, 1, 2, 2)) == 6
assert eat('?????????????..?#???', (3, 3, 1, 1, 4)) == 30
assert eat('??##?#??.?.?##?????#', (6, 1, 4, 3)) == 8
assert eat('?????.??#?????##????', (4, 12)) == 6
assert eat('??#?.????##?#??', (1, 1, 7)) == 6
assert eat('.????????#?.???#?', (5, 4)) == 4
assert eat('#??????????????.????', (3, 3, 3, 1, 3)) == 20
assert eat('??..??.??.?', (1, 2, 2)) == 2
assert eat('?#??#??.?#?', (6, 3)) == 2
assert eat('???##?????.???#?????', (7, 7)) == 12
assert eat('#.??..???#??##', (1, 2, 1, 5)) == 2
assert eat('??#??#???????', (3, 2, 5)) == 4
assert eat('???#?????#?#??.??.??', (1, 11, 1, 2)) == 6
assert eat('.???#?????????..?', (2, 7)) == 4
assert eat('?.???#???#??????#?#', (1, 5, 1, 6)) == 5
assert eat('?#????????', (1, 1, 2)) == 10
assert eat('?????.???##?##????#?', (1, 13)) == 10
assert eat('??.??#?..#.?#', (1, 4, 1, 2)) == 2
assert eat('?#..???#??#???????.?', (1, 1, 4, 3, 2)) == 2
assert eat('????.???..??#?#?', (1, 1, 1, 5)) == 26
assert eat('??.?#????????##', (1, 2, 1, 6)) == 6
assert eat('????.??#???##?#???', (1, 12)) == 8
assert eat('?##??#??????#?#??', (2, 1, 6)) == 3
assert eat('???????.????##?????', (2, 3, 3, 3, 2)) == 6
assert eat('.?.#???.??????.?', (1, 5)) == 2
assert eat('.??#??.???', (3, 2)) == 6
assert eat('?#?.#???#?#?.?.???', (2, 2, 4, 3)) == 4
assert eat('?.#??.?##?', (1, 1, 4)) == 2
assert eat('??#???..#???#?????', (1, 4, 3, 1, 1, 2)) == 1
assert eat('??..??.?#???#???', (2, 1, 3)) == 7
assert eat('?#?.?.?.???#.??#', (3, 1, 1, 3, 2)) == 1
assert eat('..??..????', (2, 2)) == 3
assert eat('????????##.?', (2, 4)) == 4
assert eat('????.??...#?????', (1, 2, 5)) == 5
assert eat('?????.??????????', (1, 8)) == 16
assert eat('??..??.????#', (1, 5)) == 4
assert eat('?.?.#???#???.?', (1, 1, 2, 5)) == 1
assert eat('??????#?????##?', (3, 9)) == 5
assert eat('?.##?????#??###?????', (3, 8, 2)) == 6
assert eat('???..????????????.?', (3, 1, 3, 1, 2)) == 15
assert eat('??????#??##??#????.?', (8, 3, 2)) == 2
assert eat('??????#.???...?', (5, 2)) == 2
assert eat('.??#?#.#.#????', (3, 1, 1, 4)) == 1
assert eat('?????.?.?????#?', (1, 5)) == 13
assert eat('?????#????#', (2, 2, 3)) == 5
assert eat('.??????#?..?????????', (1, 5, 1, 1, 3)) == 30
assert eat('?.??????#???', (1, 2, 3)) == 13
assert eat('#....?.???#?#???#?', (1, 11)) == 1
assert eat('??##???#?????##?', (7, 5)) == 4
assert eat('???.?#.??#??#', (2, 5)) == 1
assert eat('?#?.???#?#??', (1, 6)) == 3
assert eat('????#????#?', (3, 3)) == 5
assert eat('.???##?###???#?????', (5, 8, 2)) == 2
assert eat('.#????????', (1, 4)) == 4
assert eat('.??#??#?#???##?.??', (6, 1, 4, 2)) == 2
assert eat('.??.?.#????.??', (1, 1, 2, 2)) == 10
assert eat('?????.????????.?', (1, 1, 1, 1, 5)) == 3
assert eat('##?##???.?#?????#?', (7, 4, 3)) == 3
assert eat('??????#???#??.???', (8, 3, 2)) == 6
assert eat('.??#??.????????', (1, 1, 3, 2)) == 13
assert eat('.???.?##??????#??', (2, 11)) == 4
assert eat('.??.???#?.?#.?', (2, 2, 2)) == 3
assert eat('??..#???#?', (1, 2, 3)) == 2
assert eat('?...#??????.?', (1, 1, 5)) == 1
assert eat('????#??????.?#?#???', (3, 3, 1, 4, 2)) == 4
assert eat('#?..##?????????', (2, 6, 2)) == 3
assert eat('???.?...??????????', (3, 1, 9)) == 2
assert eat('.????...?#?.?', (2, 2)) == 6
assert eat('????.???##??', (2, 5)) == 9
assert eat('#?#?.???.???#??', (1, 1, 1, 1, 2)) == 11
assert eat('.??#?#.??.???????', (3, 3, 3)) == 1
assert eat('.????#.??.??????#', (3, 2, 4)) == 2
assert eat('?????#..??', (1, 1, 2)) == 5
assert eat('.?#...????', (1, 3)) == 2
assert eat('#????#??..#????.???#', (2, 3, 1, 3, 1, 3)) == 1
assert eat('?????#???##', (2, 1, 3)) == 3
assert eat('?.???.???##?#?', (1, 6)) == 9
assert eat('?##?.???#???#.#?????', (3, 1, 6, 1, 1, 2)) == 2
assert eat('#??#???#?????#', (1, 6, 1, 2)) == 3
assert eat('????###??#?#?????#??', (11, 7)) == 1
assert eat('??##.?#?#???????#?#', (2, 14)) == 1
assert eat('?.?#??????????', (4, 3, 2)) == 4
assert eat('???.#?????', (1, 4)) == 4
assert eat('??????.???#?#?', (2, 6)) == 10
assert eat('.?#??.?????.??#?##?', (2, 4, 6)) == 8
assert eat('#.#??##?.?????#?#?#?', (1, 1, 3, 1, 1, 7)) == 2
assert eat('?????????????#???', (2, 1, 1, 8)) == 15
assert eat('??#??...#???', (1, 1, 4)) == 2
assert eat('??????.??#???', (2, 2)) == 11
assert eat('??????#??#?##??????', (1, 1, 2, 11)) == 3
assert eat('#####?.?.??#?', (6, 1, 3)) == 2
assert eat('.???#?????#????', (3, 7)) == 6
assert eat('?????????#?', (1, 1, 5)) == 9
assert eat('?#??#.?###???..????', (2, 1, 6, 2)) == 12
assert eat('#??#??????.??????', (9, 2)) == 5
assert eat('??????#????#??.?', (7, 3)) == 9
assert eat('?????.??##???', (3, 6)) == 6
assert eat('?###?????##', (6, 3)) == 2
assert eat('.??.?.???#????#??', (2, 1, 2, 4)) == 12
assert eat('??#?#?#???#?.??#?', (10, 4)) == 2
assert eat('??######.?????', (6, 3)) == 3
assert eat('????.????#???', (2, 1, 4)) == 22
assert eat('.????.??#.???#?', (3, 2, 5)) == 2
assert eat('.???.???#?', (2, 3)) == 4
assert eat('?##???????.???#', (8, 2)) == 2
assert eat('.#?.##??????????', (1, 7, 2)) == 3
assert eat('????????##?.?', (1, 3, 4)) == 4
assert eat('?##?..????#????#', (3, 10)) == 2
assert eat('?.?.?.??##??', (1, 1, 1, 5)) == 2
assert eat('.?????????', (3, 5)) == 1
assert eat('#???????#??', (1, 8)) == 2
assert eat('?##?.?.#?#?', (3, 1, 3)) == 2
assert eat('.?#?????.?', (1, 3)) == 2
assert eat('.?###?##?##.??????', (7, 2, 2)) == 5
assert eat('.?..??.??????', (1, 1, 4)) == 9
assert eat('#?#.#???????', (1, 1, 1, 4)) == 3
assert eat('???#????###.????????', (1, 4, 3, 1, 1, 2)) == 30
assert eat('?#?????.???#?', (1, 1, 4)) == 8
assert eat('.?#??.????#?', (1, 5)) == 2
assert eat('??#?.#??????.????', (2, 6, 2)) == 6
assert eat('.??????#???#', (1, 3, 1, 2)) == 1
assert eat('????.?#?##.?????#??', (1, 1, 4, 1, 3)) == 27
assert eat('??#?#????.??#?#????', (1, 1, 1, 9)) == 4
assert eat('..?????????', (1, 6)) == 3
assert eat('???##?????????#.???', (12, 1, 2)) == 4
assert eat('??.??#??#??????', (6, 4)) == 3
assert eat('????#???.##??.???#', (4, 2, 4, 2)) == 1
assert eat('.??..?.????#??', (1, 1, 1, 4)) == 6
assert eat('..?#?##??#???#???', (9, 5)) == 1
assert eat('?.#????.??##??', (2, 5)) == 2
assert eat('?#?.?.?.???????', (3, 1, 1, 1, 2)) == 18
assert eat('.?#?#???#????', (2, 1, 6)) == 2
assert eat('.#?#??#.#???#?##?', (4, 1, 1, 7)) == 1
assert eat('????????.?#?????#?', (5, 2, 3)) == 16
assert eat('#?.????????', (1, 2, 2)) == 10
assert eat('..??????#????.?', (1, 2)) == 11
assert eat('###?#?..?#', (5, 2)) == 1
assert eat('.??#?????.??????', (1, 1, 2, 1, 2)) == 29
assert eat('.????.??.????#?#??', (1, 1, 1, 7)) == 29
assert eat('?.#.????????', (1, 1, 4)) == 11
assert eat('?#?#??##???##???.??', (8, 6, 2)) == 3
assert eat('#???.?.?????????#??', (3, 12)) == 1
assert eat('????.?????#????????', (1, 2, 1, 3, 7)) == 2
assert eat('#???.????#???#?', (4, 8)) == 2
assert eat('????.??#?#??????#?', (1, 11)) == 9
assert eat('??#????#????????', (4, 5, 3)) == 10
assert eat('?.???????????##?#', (2, 1, 1, 6)) == 10
assert eat('?#?.##.???', (1, 2, 2)) == 2
assert eat('?????.?????##?#??#?', (3, 2, 9)) == 9
assert eat('#??.#???????', (2, 3, 3)) == 2
assert eat('..#???#??#?', (1, 6)) == 2
assert eat('.?#.?????#', (2, 2, 3)) == 1
assert eat('.???#?#?..?????.?', (6, 5)) == 2
assert eat('#.##??##??.?#?????#', (1, 2, 5, 1, 1, 3)) == 1
assert eat('..??????#?.?', (1, 1, 2)) == 9
assert eat('.#.????????####.?', (1, 4, 6)) == 2
assert eat('?#????#?##??##?.?#', (1, 7, 2, 2)) == 2
assert eat('???????..??????', (4, 1, 3)) == 24
assert eat('?.??.#?????????.?', (4, 2)) == 4
assert eat('.???#????##??????', (2, 4, 7)) == 1
assert eat('??#?.??#????????##??', (3, 6, 6)) == 12
assert eat('.#???#????', (1, 6)) == 2
assert eat('???#.???#??#', (1, 1, 1, 4)) == 4
assert eat('?.?###??????##?.?', (4, 3, 4)) == 1
assert eat('?##??..???##', (3, 4)) == 2
assert eat('???..#?#?.????', (1, 4, 4)) == 3
assert eat('??#??..???????.?.?', (4, 2)) == 12
assert eat('???#.???###??#???#?#', (1, 1, 15)) == 2
assert eat('?#??????.??#????', (3, 1, 5)) == 23
assert eat('?????????#?', (1, 1, 6)) == 4
assert eat('??#???.????', (2, 2, 3)) == 2
assert eat('.??.?.??####?', (1, 7)) == 3
assert eat('?.??..???.#.??#???', (1, 1, 3, 1, 1, 4)) == 2
assert eat('?.?.??#.??', (1, 1, 2)) == 4
assert eat('??..?..?.???????#.??', (1, 7)) == 4
assert eat('??????#????????.?', (5, 6)) == 4
assert eat('?.#?#????.#??', (3, 1, 2)) == 3
assert eat('????.??#???.?????#?', (2, 1, 1, 1, 1, 3)) == 59
assert eat('???#.??#?#?#?#?????', (3, 1, 1, 1, 8)) == 1
assert eat('.##?????#????##??', (2, 1, 1, 6)) == 6
assert eat('?#???????.?', (1, 4)) == 3